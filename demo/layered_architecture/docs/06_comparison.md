# 4つのアーキテクチャの比較まとめ

## 概要

このドキュメントでは、レイヤード、ヘキサゴナル、オニオン、クリーンアーキテクチャの違いを様々な観点から比較します。

---

## 1. 基本比較表

| 観点 | レイヤード | ヘキサゴナル | オニオン | クリーン |
|-----|-----------|-------------|---------|---------|
| **提唱年** | 1990年代 | 2005年 | 2008年 | 2012年 |
| **提唱者** | - | Alistair Cockburn | Jeffrey Palermo | Robert C. Martin |
| **別名** | N層アーキテクチャ | Ports & Adapters | - | - |
| **依存の方向** | 上→下 | 外→内 | 外→内 | 外→内 |
| **中心概念** | 層（Layer） | Port/Adapter | Domain Model | Entity/UseCase |
| **DB層の位置** | 最下層（基盤） | 外側（Adapter） | 最外層 | 最外層 |

---

## 2. 構造の比較

### 2.1 図解比較

```
【レイヤードアーキテクチャ】

    ┌─────────────────┐
    │  Presentation   │
    ├─────────────────┤
    │    Business     │
    ├─────────────────┤
    │   Persistence   │
    ├─────────────────┤
    │    Database     │  ← 基盤
    └─────────────────┘

    依存: 上 → 下


【ヘキサゴナルアーキテクチャ】

         Adapter
            │
            ▼
    ┌───────────────┐
    │     Port      │
    │  (Interface)  │
    └───────┬───────┘
            │
    ┌───────▼───────┐
    │  Application  │
    │     Core      │
    └───────┬───────┘
            │
    ┌───────▼───────┐
    │     Port      │
    └───────┬───────┘
            │
            ▼
         Adapter

    依存: 外 → 内


【オニオンアーキテクチャ】

    ┌─────────────────────────┐
    │     Infrastructure      │
    │  ┌───────────────────┐  │
    │  │   Application     │  │
    │  │  ┌─────────────┐  │  │
    │  │  │   Domain    │  │  │
    │  │  │  ┌───────┐  │  │  │
    │  │  │  │ Model │  │  │  │
    │  │  │  └───────┘  │  │  │
    │  │  └─────────────┘  │  │
    │  └───────────────────┘  │
    └─────────────────────────┘

    依存: 外 → 内（同心円）


【クリーンアーキテクチャ】

    ┌─────────────────────────┐
    │  Frameworks & Drivers   │
    │  ┌───────────────────┐  │
    │  │ Interface Adapters│  │
    │  │  ┌─────────────┐  │  │
    │  │  │  Use Cases  │  │  │
    │  │  │  ┌───────┐  │  │  │
    │  │  │  │Entity │  │  │  │
    │  │  │  └───────┘  │  │  │
    │  │  └─────────────┘  │  │
    │  └───────────────────┘  │
    └─────────────────────────┘

    依存: 外 → 内（同心円 + Port）
```

### 2.2 層の対応関係

```
┌─────────────┬─────────────┬─────────────────┬─────────────────┐
│  レイヤード  │ ヘキサゴナル │     オニオン     │    クリーン     │
├─────────────┼─────────────┼─────────────────┼─────────────────┤
│             │             │                 │                 │
│ Presentation│ Input       │ Infrastructure  │ Frameworks &    │
│             │ Adapter     │ (UI部分)        │ Drivers         │
│             │             │                 │                 │
├─────────────┼─────────────┼─────────────────┼─────────────────┤
│             │             │                 │                 │
│     -       │ Input Port  │      -          │ Interface       │
│             │             │                 │ Adapters        │
│             │             │                 │ (Controller)    │
│             │             │                 │                 │
├─────────────┼─────────────┼─────────────────┼─────────────────┤
│             │             │                 │                 │
│  Business   │ Application │ Application     │ Use Cases       │
│             │ Core        │ Services        │                 │
│             │             │                 │                 │
├─────────────┼─────────────┼─────────────────┼─────────────────┤
│             │             │                 │                 │
│     -       │     -       │ Domain Services │      -          │
│             │             │                 │                 │
├─────────────┼─────────────┼─────────────────┼─────────────────┤
│             │             │                 │                 │
│     -       │     -       │ Domain Model    │ Entities        │
│             │             │                 │                 │
├─────────────┼─────────────┼─────────────────┼─────────────────┤
│             │             │                 │                 │
│ Persistence │ Output Port │ Repository IF   │ Output Port     │
│             │             │ (Domain層で定義)│ (UseCase層で定義)│
│             │             │                 │                 │
├─────────────┼─────────────┼─────────────────┼─────────────────┤
│             │             │                 │                 │
│  Database   │ Output      │ Infrastructure  │ Interface       │
│             │ Adapter     │ (DB実装)        │ Adapters        │
│             │             │                 │ (Gateway)       │
│             │             │                 │                 │
└─────────────┴─────────────┴─────────────────┴─────────────────┘
```

---

## 3. 依存関係の比較

### 3.1 レイヤード vs 他の3つ

```
【レイヤード】

Business Layer
      │
      │ 直接依存（具象クラス）
      ▼
┌─────────────────┐
│PostgresUserRepo │
└─────────────────┘

問題: Business層がPostgreSQLに依存
→ DB変更時にBusiness層も変更が必要


【ヘキサゴナル/オニオン/クリーン】

Business Layer
      │
      │ インターフェースに依存
      ▼
┌─────────────────┐
│ UserRepository  │  ← Interface
│   (Port)        │
└─────────────────┘
         ▲
         │ 実装
┌─────────────────┐
│PostgresUserRepo │  ← Adapter
└─────────────────┘

利点: Business層はインターフェースのみ知っている
→ DB変更時はAdapterを差し替えるだけ
```

### 3.2 インターフェースの定義場所

```
┌─────────────────────────────────────────────────────────────┐
│                  インターフェースはどこで定義？              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  レイヤード:                                                 │
│    インターフェースなし（または任意）                        │
│                                                             │
│  ヘキサゴナル:                                               │
│    Port として Application Core 側で定義                    │
│                                                             │
│  オニオン:                                                   │
│    Domain層（repository/service.go）で定義                  │
│                                                             │
│  クリーン:                                                   │
│    UseCase層の Output Port として定義                       │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  共通点: 「使う側」でインターフェースを定義                  │
│         → 依存関係逆転の原則（DIP）                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. 特徴の比較

### 4.1 各アーキテクチャの特徴

```
┌─────────────────────────────────────────────────────────────┐
│                   レイヤードアーキテクチャ                   │
├─────────────────────────────────────────────────────────────┤
│  ✅ シンプルで理解しやすい                                   │
│  ✅ 学習コストが低い                                         │
│  ✅ 小規模プロジェクトに最適                                 │
│  ❌ ビジネス層がDBに依存                                     │
│  ❌ テストが困難                                             │
│  ❌ 変更の影響範囲が大きい                                   │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                 ヘキサゴナルアーキテクチャ                   │
├─────────────────────────────────────────────────────────────┤
│  ✅ Port/Adapterで技術を隔離                                 │
│  ✅ テスタビリティが高い                                     │
│  ✅ 入力/出力の対称性                                        │
│  ❌ Core内部の構造は未定義                                   │
│  ❌ 小規模には過剰                                           │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                  オニオンアーキテクチャ                      │
├─────────────────────────────────────────────────────────────┤
│  ✅ ドメインモデル中心の設計                                 │
│  ✅ DDDとの親和性が高い                                      │
│  ✅ 層構造が明確                                             │
│  ❌ Domain ServicesとApplication Servicesの境界が曖昧       │
│  ❌ 学習コストがある                                         │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                  クリーンアーキテクチャ                      │
├─────────────────────────────────────────────────────────────┤
│  ✅ 4層とPortが明確に定義                                    │
│  ✅ 複数アーキテクチャを統合した標準                         │
│  ✅ Input/Output Portパターン                               │
│  ❌ 最も複雑、コード量が多い                                 │
│  ❌ 学習コストが高い                                         │
│  ❌ 小規模プロジェクトには過剰                               │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 数値比較

| 観点 | レイヤード | ヘキサゴナル | オニオン | クリーン |
|-----|:---------:|:-----------:|:-------:|:-------:|
| 複雑さ | ★☆☆☆☆ | ★★★☆☆ | ★★★☆☆ | ★★★★★ |
| 学習コスト | ★☆☆☆☆ | ★★☆☆☆ | ★★★☆☆ | ★★★★☆ |
| テスタビリティ | ★★☆☆☆ | ★★★★☆ | ★★★★☆ | ★★★★★ |
| 柔軟性 | ★★☆☆☆ | ★★★★☆ | ★★★★☆ | ★★★★★ |
| 初期開発速度 | ★★★★★ | ★★★☆☆ | ★★★☆☆ | ★★☆☆☆ |
| 長期保守性 | ★★☆☆☆ | ★★★★☆ | ★★★★☆ | ★★★★★ |

---

## 5. ユースケース別の選択指針

### 5.1 プロジェクト規模別

```
┌─────────────────────────────────────────────────────────────┐
│                    小規模プロジェクト                        │
│              （〜3人、〜3ヶ月、シンプルなCRUD）              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  推奨: レイヤードアーキテクチャ                              │
│                                                             │
│  理由:                                                      │
│  ・素早く作れる                                              │
│  ・チームが理解しやすい                                      │
│  ・オーバーエンジニアリングを避けられる                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    中規模プロジェクト                        │
│            （3〜10人、6ヶ月〜1年、ある程度の複雑さ）         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  推奨: オニオン or ヘキサゴナル                              │
│                                                             │
│  理由:                                                      │
│  ・テスタビリティが重要になる                                │
│  ・ドメインロジックが複雑になりがち                          │
│  ・クリーンほど複雑でなく、レイヤードより柔軟                │
│                                                             │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    大規模プロジェクト                        │
│           （10人以上、1年以上、複雑なドメイン）              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  推奨: クリーンアーキテクチャ                                │
│                                                             │
│  理由:                                                      │
│  ・明確な層と責務が必要                                      │
│  ・複数チームでの協業に適している                            │
│  ・長期的な保守性が重要                                      │
│  ・初期コストを回収できる                                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 チーム状況別

```
┌─────────────────────────────────────────────────────────────┐
│              チームがアーキテクチャに不慣れ                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  開始: レイヤード                                            │
│  進化: 必要に応じてオニオンへ移行                            │
│                                                             │
│  段階的にインターフェースを導入し、                          │
│  チームの理解に合わせて進化させる                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│              チームがDDDに精通している                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  推奨: オニオン or クリーン                                  │
│                                                             │
│  DDDのEntity、Value Object、Domain Serviceが                │
│  自然に配置できる                                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│              複数チームでの分業が必要                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  推奨: クリーン                                              │
│                                                             │
│  明確な層境界がチーム間の契約になる                          │
│  ・チームA: Use Cases担当                                    │
│  ・チームB: Adapter担当                                      │
│  ・インターフェースで合意                                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 6. 進化のパス

### 6.1 レイヤードからの進化

```
                    レイヤード
                        │
                        │ 問題が顕在化
                        │ ・テストが困難
                        │ ・変更の影響範囲が大きい
                        ▼
    ┌───────────────────────────────────────┐
    │       インターフェースの導入           │
    │                                       │
    │  Business層でRepository IFを定義      │
    │  Persistence層で実装                  │
    └───────────────────┬───────────────────┘
                        │
                        ▼
    ┌───────────────────────────────────────┐
    │           オニオン/ヘキサゴナル        │
    │                                       │
    │  ドメインを中心に再構成               │
    │  依存関係を内側に向ける               │
    └───────────────────┬───────────────────┘
                        │
                        │ さらに明確な構造が必要
                        ▼
    ┌───────────────────────────────────────┐
    │             クリーン                  │
    │                                       │
    │  Use Cases層を明確化                  │
    │  Input/Output Portを導入             │
    └───────────────────────────────────────┘
```

### 6.2 段階的なリファクタリング例

```go
// Step 1: レイヤード（最初の状態）
type UserService struct {
    db *sql.DB  // 直接依存
}

// Step 2: インターフェース導入
type UserRepository interface {
    FindByID(id string) (*User, error)
}

type UserService struct {
    repo UserRepository  // インターフェースに依存
}

// Step 3: ドメインモデルの充実（オニオン）
// domain/model/user.go
type User struct {
    // ビジネスルールをここに
}

// domain/repository/user_repository.go
type UserRepository interface {
    // Domain層でIF定義
}

// Step 4: Use Casesの明確化（クリーン）
// usecase/port/input/create_user.go
type CreateUserInputPort interface {
    Execute(input CreateUserInput) (*CreateUserOutput, error)
}

// usecase/interactor/create_user.go
type CreateUserInteractor struct {
    // ...
}
```

---

## 7. よくある誤解

### 7.1 「クリーン = 最良」ではない

```
┌─────────────────────────────────────────────────────────────┐
│  ❌ 誤解: クリーンアーキテクチャは常に最良の選択             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ✅ 現実:                                                   │
│                                                             │
│  ・小規模プロジェクトには過剰                                │
│  ・学習コストがかかる                                        │
│  ・初期開発が遅くなる                                        │
│                                                             │
│  「最良のアーキテクチャ」は                                  │
│  プロジェクトの規模・チーム・期間によって異なる              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 7.2 「レイヤード = 悪い」ではない

```
┌─────────────────────────────────────────────────────────────┐
│  ❌ 誤解: レイヤードアーキテクチャは時代遅れ                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ✅ 現実:                                                   │
│                                                             │
│  ・適切なケースでは最も効率的                                │
│  ・シンプルなCRUD、プロトタイプに最適                        │
│  ・多くのフレームワークがこの構造を前提                      │
│                                                             │
│  問題点を理解した上で使えば有効なツール                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 7.3 「ヘキサゴナル/オニオン/クリーンは同じ」ではない

```
┌─────────────────────────────────────────────────────────────┐
│  ❌ 誤解: 3つは名前が違うだけで同じもの                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ✅ 現実:                                                   │
│                                                             │
│  本質（依存は内側へ）は同じだが、違いがある:                 │
│                                                             │
│  ・ヘキサゴナル: Port/Adapterの概念を強調                   │
│  ・オニオン: 層構造とドメイン中心を強調                      │
│  ・クリーン: 4層とInput/Output Portを明確に定義            │
│                                                             │
│  それぞれの強調点を理解して選択する                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 8. 決定フローチャート

```
                        START
                          │
                          ▼
              ┌───────────────────────┐
              │ プロジェクト規模は？  │
              └───────────┬───────────┘
                          │
          ┌───────────────┼───────────────┐
          │               │               │
          ▼               ▼               ▼
      小規模          中規模          大規模
          │               │               │
          │               │               │
          ▼               ▼               ▼
    ┌───────────┐   ┌───────────────┐   ┌───────────┐
    │テストは   │   │DDDを実践？    │   │複数チーム？│
    │重要？     │   └───────┬───────┘   └─────┬─────┘
    └─────┬─────┘           │                 │
          │           ┌─────┴─────┐           │
    ┌─────┴─────┐     │           │     ┌─────┴─────┐
    │           │     ▼           ▼     │           │
    ▼           ▼   はい         いいえ  ▼           ▼
  いいえ      はい    │           │    はい       いいえ
    │           │     ▼           ▼     │           │
    │           │  オニオン   ヘキサゴナル│           │
    │           │                       │           │
    ▼           ▼                       ▼           ▼
 レイヤード  オニオン                 クリーン   オニオン
             or
          ヘキサゴナル
```

---

## 9. まとめ

### 9.1 一言まとめ

| アーキテクチャ | 一言で言うと |
|--------------|------------|
| **レイヤード** | シンプルに層で分ける |
| **ヘキサゴナル** | Port/Adapterで外部を隔離 |
| **オニオン** | ドメインを中心に守る |
| **クリーン** | 全部入り、明確な定義 |

### 9.2 選択の指針

```
┌─────────────────────────────────────────────────────────────┐
│                      最終的な選択指針                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. まずプロジェクトの特性を見極める                         │
│     ・規模、期間、チーム、ドメインの複雑さ                   │
│                                                             │
│  2. チームの理解度を考慮する                                 │
│     ・全員が理解できないアーキテクチャは機能しない           │
│                                                             │
│  3. オーバーエンジニアリングを避ける                         │
│     ・必要十分なものを選ぶ                                   │
│                                                             │
│  4. 進化の余地を残す                                         │
│     ・後からリファクタリングできる構造に                     │
│                                                             │
│  5. 一貫性を保つ                                             │
│     ・選んだアーキテクチャを全体で統一する                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 9.3 覚えておくべきこと

```
┌─────────────────────────────────────────────────────────────┐
│                    共通する本質                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  4つのアーキテクチャすべてに共通する目的:                    │
│                                                             │
│  ・関心の分離                                                │
│  ・ビジネスロジックの保護                                    │
│  ・テスタビリティの向上                                      │
│  ・変更容易性の確保                                          │
│                                                             │
│  これらを達成する「手段」が異なるだけ。                      │
│  目的を理解した上で、プロジェクトに合った手段を選ぶ。        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 参考資料

- [The Clean Architecture - Robert C. Martin](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html)
- [Hexagonal Architecture - Alistair Cockburn](https://alistair.cockburn.us/hexagonal-architecture/)
- [The Onion Architecture - Jeffrey Palermo](https://jeffreypalermo.com/2008/07/the-onion-architecture-part-1/)
- Clean Architecture: A Craftsman's Guide to Software Structure and Design (書籍)
