package main

import (
	"fmt"
	"math"
	"strings"
)

func main() {
	fmt.Println(strings.Repeat("=", 80))
	fmt.Println("å…·ä½“ä¾‹: 100ä¸‡ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã§user_id=500ã‚’æ¢ã™")
	fmt.Println(strings.Repeat("=", 80))

	n := 1000000 // 100ä¸‡ä»¶

	// ========================================
	// äºŒåˆ†æ¢ç´¢æœ¨ã®å ´åˆ
	// ========================================
	fmt.Println("\nã€äºŒåˆ†æ¢ç´¢æœ¨ï¼ˆBSTï¼‰ã®å ´åˆã€‘")
	fmt.Println(strings.Repeat("-", 80))

	bstHeight := int(math.Ceil(math.Log2(float64(n))))
	fmt.Printf("ãƒ‡ãƒ¼ã‚¿ä»¶æ•°: %dä»¶\n", n)
	fmt.Printf("ãƒ„ãƒªãƒ¼ã®é«˜ã•: logâ‚‚(%d) = %d\n", n, bstHeight)
	fmt.Println()

	fmt.Println("æ¢ç´¢ã®æµã‚Œ:")
	fmt.Println()
	fmt.Println("ãƒ«ãƒ¼ãƒˆãƒãƒ¼ãƒ‰        [500000]       â† 1å›ç›®ã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚¢ã‚¯ã‚»ã‚¹")
	fmt.Println("                   /")
	fmt.Println("ãƒ¬ãƒ™ãƒ«2         [250000]           â† 2å›ç›®ã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚¢ã‚¯ã‚»ã‚¹")
	fmt.Println("                /")
	fmt.Println("ãƒ¬ãƒ™ãƒ«3      [125000]              â† 3å›ç›®ã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚¢ã‚¯ã‚»ã‚¹")
	fmt.Println("             /")
	fmt.Println("ãƒ¬ãƒ™ãƒ«4    [62500]                 â† 4å›ç›®ã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚¢ã‚¯ã‚»ã‚¹")
	fmt.Println("           /")
	fmt.Println("        ... (ç¶šã)")
	fmt.Println("           \\")
	fmt.Println("ãƒ¬ãƒ™ãƒ«20    [500] âœ…               â† 20å›ç›®ã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚¢ã‚¯ã‚»ã‚¹")
	fmt.Println()
	fmt.Printf("ãƒ‡ã‚£ã‚¹ã‚¯ã‚¢ã‚¯ã‚»ã‚¹å›æ•°: %då›\n", bstHeight)
	fmt.Printf("æ‰€è¦æ™‚é–“: %då› Ã— 10ms = %dms\n", bstHeight, bstHeight*10)
	fmt.Println()
	fmt.Println("å„ãƒãƒ¼ãƒ‰ã®å†…å®¹:")
	fmt.Println("  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
	fmt.Println("  â”‚  key: 500000    â”‚")
	fmt.Println("  â”‚  left: 0x1234   â”‚  â† å·¦ã®å­ã®ã‚¢ãƒ‰ãƒ¬ã‚¹")
	fmt.Println("  â”‚  right: 0x5678  â”‚  â† å³ã®å­ã®ã‚¢ãƒ‰ãƒ¬ã‚¹")
	fmt.Println("  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")
	fmt.Println("  ã‚µã‚¤ã‚º: 20 bytes")
	fmt.Println()
	fmt.Println("å•é¡Œç‚¹:")
	fmt.Println("  âŒ 1å›ã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã§1ã¤ã®ã‚­ãƒ¼ã—ã‹è¦‹ã‚‰ã‚Œãªã„")
	fmt.Println("  âŒ ãƒ‡ã‚£ã‚¹ã‚¯ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆ4KBï¼‰ã®ã»ã¨ã‚“ã©ãŒç„¡é§„")
	fmt.Println("  âŒ 20å›ã‚‚ãƒ‡ã‚£ã‚¹ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦")

	// ========================================
	// B-Treeã®å ´åˆ
	// ========================================
	fmt.Println("\n" + strings.Repeat("=", 80))
	fmt.Println("ã€B-Treeã®å ´åˆï¼ˆæ¬¡æ•°=501, å„ãƒãƒ¼ãƒ‰ã«500å€‹ã®ã‚­ãƒ¼ï¼‰ã€‘")
	fmt.Println(strings.Repeat("-", 80))

	btreeOrder := 501
	btreeHeight := int(math.Ceil(math.Log(float64(n)) / math.Log(float64(btreeOrder))))
	fmt.Printf("ãƒ‡ãƒ¼ã‚¿ä»¶æ•°: %dä»¶\n", n)
	fmt.Printf("æ¬¡æ•°: %dï¼ˆå„ãƒãƒ¼ãƒ‰ã«æœ€å¤§%då€‹ã®ã‚­ãƒ¼ï¼‰\n", btreeOrder, btreeOrder-1)
	fmt.Printf("ãƒ„ãƒªãƒ¼ã®é«˜ã•: logâ‚…â‚€â‚(%d) = %d\n", n, btreeHeight)
	fmt.Println()

	fmt.Println("æ¢ç´¢ã®æµã‚Œ:")
	fmt.Println()
	fmt.Println("ãƒ«ãƒ¼ãƒˆãƒãƒ¼ãƒ‰ï¼ˆãƒ¬ãƒ™ãƒ«1ï¼‰              â† 1å›ç›®ã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚¢ã‚¯ã‚»ã‚¹")
	fmt.Println("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
	fmt.Println("â”‚ [1000, 2000, 3000, ..., 500000,â”‚")
	fmt.Println("â”‚  501000, 502000, ..., 999000] â”‚")
	fmt.Println("â”‚ â† 500å€‹ã®ã‚­ãƒ¼ãŒå…¥ã£ã¦ã„ã‚‹ï¼    â”‚")
	fmt.Println("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")
	fmt.Println("          â†“ 500ã‚ˆã‚Šå¤§ãã501000ã‚ˆã‚Šå°ã•ã„ â†’ å·¦ã®å­ã¸")
	fmt.Println()
	fmt.Println("ãƒ¬ãƒ™ãƒ«2ã®ãƒãƒ¼ãƒ‰                      â† 2å›ç›®ã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚¢ã‚¯ã‚»ã‚¹")
	fmt.Println("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
	fmt.Println("â”‚ [2, 4, 6, ..., 500, 502, ..., â”‚")
	fmt.Println("â”‚  998, 1000]                   â”‚")
	fmt.Println("â”‚ â† ã¾ãŸ500å€‹ã®ã‚­ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯    â”‚")
	fmt.Println("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")
	fmt.Println("          â†“ 500ã‚’ç™ºè¦‹ï¼")
	fmt.Println()
	fmt.Println("ãƒ¬ãƒ™ãƒ«3ã®ãƒªãƒ¼ãƒ•ãƒãƒ¼ãƒ‰                â† 3å›ç›®ã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚¢ã‚¯ã‚»ã‚¹")
	fmt.Println("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
	fmt.Println("â”‚ user_id=500 ã®ãƒ‡ãƒ¼ã‚¿ã¸ã®ãƒã‚¤ãƒ³ã‚¿â”‚")
	fmt.Println("â”‚ RowID: [1, 3, 5, 8, 12, ...]  â”‚")
	fmt.Println("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")
	fmt.Println("          â†“")
	fmt.Println("       âœ… è¦‹ã¤ã‹ã£ãŸï¼")
	fmt.Println()
	fmt.Printf("ãƒ‡ã‚£ã‚¹ã‚¯ã‚¢ã‚¯ã‚»ã‚¹å›æ•°: %då›\n", btreeHeight)
	fmt.Printf("æ‰€è¦æ™‚é–“: %då› Ã— 10ms = %dms\n", btreeHeight, btreeHeight*10)
	fmt.Println()
	fmt.Println("å„ãƒãƒ¼ãƒ‰ã®å†…å®¹:")
	fmt.Println("  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
	fmt.Println("  â”‚ keys: [1000, 2000, ..., 500å€‹]â”‚")
	fmt.Println("  â”‚ children: [0x1234, 0x5678,...]â”‚")
	fmt.Println("  â”‚           â† 501å€‹ã®å­ãƒã‚¤ãƒ³ã‚¿ â”‚")
	fmt.Println("  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")
	fmt.Println("  ã‚µã‚¤ã‚º: ç´„8KBï¼ˆãƒ‡ã‚£ã‚¹ã‚¯ãƒ–ãƒ­ãƒƒã‚¯ã‚’æœ€å¤§æ´»ç”¨ï¼‰")
	fmt.Println()
	fmt.Println("åˆ©ç‚¹:")
	fmt.Println("  âœ… 1å›ã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã§500å€‹ã®ã‚­ãƒ¼ã‚’è¦‹ã‚‰ã‚Œã‚‹")
	fmt.Println("  âœ… ãƒ‡ã‚£ã‚¹ã‚¯ãƒ–ãƒ­ãƒƒã‚¯ã‚’åŠ¹ç‡çš„ã«ä½¿ã†")
	fmt.Println("  âœ… ã‚ãšã‹3å›ã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã§å®Œäº†")

	// ========================================
	// æ¯”è¼ƒè¡¨
	// ========================================
	fmt.Println("\n" + strings.Repeat("=", 80))
	fmt.Println("ã€æ€§èƒ½æ¯”è¼ƒã€‘")
	fmt.Println(strings.Repeat("=", 80))

	fmt.Println()
	fmt.Printf("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n")
	fmt.Printf("â”‚ é …ç›®             â”‚ äºŒåˆ†æ¢ç´¢æœ¨     â”‚ B-Tree         â”‚\n")
	fmt.Printf("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n")
	fmt.Printf("â”‚ ãƒ„ãƒªãƒ¼ã®é«˜ã•     â”‚ %14d â”‚ %14d â”‚\n", bstHeight, btreeHeight)
	fmt.Printf("â”‚ ãƒ‡ã‚£ã‚¹ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ â”‚ %14d â”‚ %14d â”‚\n", bstHeight, btreeHeight)
	fmt.Printf("â”‚ æ‰€è¦æ™‚é–“         â”‚ %11dms â”‚ %11dms â”‚\n", bstHeight*10, btreeHeight*10)
	fmt.Printf("â”‚ ãƒãƒ¼ãƒ‰ã‚µã‚¤ã‚º     â”‚ %11dB  â”‚ %11dKB â”‚\n", 20, 8)
	fmt.Printf("â”‚ 1ãƒãƒ¼ãƒ‰ã®ã‚­ãƒ¼æ•°  â”‚ %14d â”‚ %14d â”‚\n", 1, btreeOrder-1)
	fmt.Printf("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n")

	speedup := float64(bstHeight*10) / float64(btreeHeight*10)
	fmt.Printf("\nğŸ“Š B-Treeã¯äºŒåˆ†æ¢ç´¢æœ¨ã® %.1få€é€Ÿã„ï¼\n", speedup)

	// ========================================
	// ãƒ‡ãƒ¼ã‚¿é‡ã«ã‚ˆã‚‹é•ã„
	// ========================================
	fmt.Println("\n" + strings.Repeat("=", 80))
	fmt.Println("ã€ãƒ‡ãƒ¼ã‚¿é‡ã«ã‚ˆã‚‹æ€§èƒ½ã®é•ã„ã€‘")
	fmt.Println(strings.Repeat("=", 80))

	fmt.Println()
	fmt.Printf("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n")
	fmt.Printf("â”‚ ãƒ‡ãƒ¼ã‚¿ä»¶æ•°   â”‚ BST (logâ‚‚)     â”‚ B-Tree (logâ‚…â‚€â‚)â”‚ é€Ÿåº¦æ¯”   â”‚\n")
	fmt.Printf("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n")

	testSizes := []int{1000, 10000, 100000, 1000000, 10000000, 100000000}
	for _, size := range testSizes {
		bstH := int(math.Ceil(math.Log2(float64(size))))
		btreeH := int(math.Ceil(math.Log(float64(size)) / math.Log(float64(btreeOrder))))
		ratio := float64(bstH) / float64(btreeH)

		if size >= 1000000 {
			fmt.Printf("â”‚ %,12d â”‚ %14d â”‚ %14d â”‚ %.1få€    â”‚\n", size, bstH, btreeH, ratio)
		} else {
			fmt.Printf("â”‚ %12d â”‚ %14d â”‚ %14d â”‚ %.1få€    â”‚\n", size, bstH, btreeH, ratio)
		}
	}
	fmt.Printf("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n")

	fmt.Println("\nğŸ“ˆ ãƒ‡ãƒ¼ã‚¿ãŒå¢—ãˆã‚‹ã»ã©ã€B-Treeã®å„ªä½æ€§ãŒé¡•è‘—ã«ãªã‚‹ï¼")

	// ========================================
	// å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã®ä½¿ç”¨ä¾‹
	// ========================================
	fmt.Println("\n" + strings.Repeat("=", 80))
	fmt.Println("ã€å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã®ä½¿ç”¨ä¾‹ã€‘")
	fmt.Println(strings.Repeat("=", 80))

	fmt.Println("\nã‚ãªãŸã®ã‚³ãƒ¼ãƒ‰ã§ã®å®Ÿä¾‹:")
	fmt.Println()
	fmt.Println("// models.go")
	fmt.Println("type OrderIndexed struct {")
	fmt.Println("    ID      uint `gorm:\"primaryKey\"`")
	fmt.Println("    UserID  int  `gorm:\"index:idx_order_user_id\"` â† B+TreeãŒä½œã‚‰ã‚Œã‚‹ï¼")
	fmt.Println("    ...çœç•¥...")
	fmt.Println("}")
	fmt.Println()
	fmt.Println("// main.go")
	fmt.Println("orders, err := FindOrdersByUserIDIndexed(db, 500)")
	fmt.Println("// â†“ å†…éƒ¨çš„ã«ã¯")
	fmt.Println("// SELECT * FROM order_indexeds WHERE user_id = 500;")
	fmt.Println()
	fmt.Println("å®Ÿè¡Œãƒ•ãƒ­ãƒ¼:")
	fmt.Println("  1. SQLiteãŒidx_order_user_idã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆB+Treeï¼‰ã‚’é¸æŠ")
	fmt.Println("  2. B+Treeã§user_id=500ã‚’æ¤œç´¢ï¼ˆ2-3å›ã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ï¼‰")
	fmt.Println("  3. è©²å½“ã™ã‚‹RowIDã‚’å–å¾—")
	fmt.Println("  4. ãƒ¡ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰å®Ÿãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—")
	fmt.Println()
	fmt.Println("ã‚‚ã—äºŒåˆ†æ¢ç´¢æœ¨ã ã£ãŸã‚‰:")
	fmt.Println("  - 10,000ä»¶ã®ãƒ‡ãƒ¼ã‚¿ â†’ ç´„14å›ã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚¢ã‚¯ã‚»ã‚¹")
	fmt.Println("  - B+Tree â†’ ç´„3å›ã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚¢ã‚¯ã‚»ã‚¹")
	fmt.Println("  â†’ ç´„4.7å€é…ããªã‚‹ï¼")
}
